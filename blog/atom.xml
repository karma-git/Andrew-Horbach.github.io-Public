<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://your-docusaurus-test-site.com/Andrew-Horbach.github.io-Public/blog</id>
    <title>Andrew Horbach Blog</title>
    <updated>2022-01-28T00:00:00.000Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://your-docusaurus-test-site.com/Andrew-Horbach.github.io-Public/blog"/>
    <subtitle>Andrew Horbach Blog</subtitle>
    <icon>https://your-docusaurus-test-site.com/Andrew-Horbach.github.io-Public/img/favicon.ico</icon>
    <entry>
        <title type="html"><![CDATA[Selfmade Vagrant box]]></title>
        <id>selfmade-vagrant-box</id>
        <link href="https://your-docusaurus-test-site.com/Andrew-Horbach.github.io-Public/blog/selfmade-vagrant-box"/>
        <updated>2022-01-28T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[VagrantBox собирается настолько же просто как и DockerImage!]]></summary>
        <content type="html"><![CDATA[<p>На VagrantCloud не нашел нормальных box-ов с GUI.</p><h2>Процесс</h2><p>:::info
Буду делать аналогии с <em>docker</em>
:::</p><h3>config file</h3><p>Описываем конфигурацию нашего VagrantBox (<em>DockerImage</em>) в формате <code>.hcl</code> (<em>terraform</em>)</p><pre><code class="language-hcl">source &quot;vagrant&quot; &quot;ubuntu&quot; {
  add_force    = true
  communicator = &quot;ssh&quot;
  provider     = &quot;virtualbox&quot;
  source_path  = &quot;ubuntu/focal64&quot;
}

build {
  name    = &quot;learn-packer&quot;
  sources = [
    &quot;source.vagrant.ubuntu&quot;
  ]
}
</code></pre><p>:::tip
Полезные команды:</p><pre><code class="language-shell">packer validate packer.hcl  # валидирует файл
packer fmt .                # форматирует файлы, и кажется, выполняет валидацию
</code></pre><p>:::</p><h3>build</h3><p>С помощью <a href="https://www.packer.io/"><code>packer</code></a> (<em>docker engine</em>) собираем образ.</p><pre><code class="language-shell">packer build packer.hcl
</code></pre><p>Через некоторое время в директории <code>learn-packer</code> появится файл <code>.box</code> (<em>docker_image</em>)</p><h3>push</h3><p>Заливаем получившийся файл на <a href="https://app.vagrantup.com/boxes/search">VagrantCloud</a>. Понадобиться собрать хэш-сумму файла, например через <code>md5</code></p><h3>provisioner</h3><p>:::note
Любимый провиженер - ansible, но можно использовать <code>shell</code>
:::</p><div><div value="hcl" label="packer.hcl"><pre><code class="language-hcl">source &quot;vagrant&quot; &quot;ubuntu&quot; {
  add_force    = true
  communicator = &quot;ssh&quot;
  provider     = &quot;virtualbox&quot;
  source_path  = &quot;ubuntu/focal64&quot;
}

build {
  name    = &quot;learn-packer&quot;
  sources = [
    &quot;source.vagrant.ubuntu&quot;
  ]
  provisioner &quot;ansible&quot; {
    playbook_file = &quot;./ansible/packer-playbook.yml&quot;
  }
}
</code></pre></div><div value="yml" label="packer-playbook.yml"><pre><code class="language-yml">---

- name: install docker engine ubuntu
  hosts: all

  become: true
  become_method: sudo

  tasks:
    - name: 1. Update the apt package index and install packages to allow apt to use a repository over HTTPS
      apt:
        name: 
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
          - python3-pip
          - awscli
        state: latest
        update_cache: true

    - name: 2. Add Docker’s official GPG key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: 3. Add Docker Repository
      apt_repository:
        repo: deb https://download.docker.com/linux/ubuntu focal stable  # FIXME move to var
        state: present

    - name: 4. Install docker engine
      apt:
        name: docker-ce
        state: latest
        update_cache: true

    # Docker post-install steps for ubuntu

    - name: 1. Make sure that group &quot;docker&quot; exists
      group:
        name: docker
        state: present

    - name: 2. Add aws user to docker docker group
      user:
        name: ubuntu
        groups: docker
        append: true
</code></pre></div></div><h3>post-processors</h3><p>:::caution
Не протестировал
:::</p><p>Штуки которые выполняются после сборки, например публикация в <em>VagrantCloud</em> (<em>docker push</em>)</p><p><a href="https://github.com/karma-git/playground/tree/master/environment/vagrant/ubuntu-gui">GitHub repo</a></p>]]></content>
        <author>
            <name>Andrew Horbach</name>
            <uri>https://github.com/karma-git</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[AWS Free Tier и Packer Tutorial]]></title>
        <id>aws-ebs-snapshot</id>
        <link href="https://your-docusaurus-test-site.com/Andrew-Horbach.github.io-Public/blog/aws-ebs-snapshot"/>
        <updated>2021-01-30T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Используете AWS Free Tier? Настроили Billing Alarms?]]></summary>
        <content type="html"><![CDATA[<h1>Предыстория</h1><p>Когда я только знакомился с AWS по youtube плейлисту, я смастерил <code>VPC</code> в двух <code>AZ</code> с несколькими подсетями. Один из типов подсетей был private - с <code>nat-gateway</code>, в курсах забыли сказать, что они не входят во фритир. За пару дней за 2 гейта накапало около <strong>$6</strong>. Было обидно, я поставил биллинг аларм.</p><p>:::info #!NOTE
Тот самый курс от <a href="https://www.youtube.com/watch?v=8jbx8O3wuLg&amp;list=PLg5SS_4L6LYsxrZ_4xE_U95AtGsIB96k9">Курс ADV-IT</a>
:::</p><h1>История</h1><p>Совсем недавно я учился (на котиках) созданию артефактов с помощью <a href="./blog/selfmade-vagrant-box">packer</a>. После тренировки в AWS я со спокойной душой в console нужного региона убил все <code>AMI</code> и пошел дальше.</p><p>Неделю спустя в почте заметил очередное письмо от AWS (мне иногда на личный gmail аккаунт приходят от них billing репорты, всегда пустые, и приглашения не <a href="https://reinvent.awsevents.com/">re:invent</a>).</p><p><img src="./static/aws-ebs-snapshot-warn.png" alt="alert"/></p><p>Увидел что я потратил 85% <em>&quot;фри-тирного&quot;</em> места под снэпшоты ebs дисков.</p><p>:::info
<a href="https://aws.amazon.com/free/?all-free-tier.sort-by=item.additionalFields.SortRank&amp;all-free-tier.sort-order=asc&amp;awsf.Free%20Tier%20Types=*all&amp;awsf.Free%20Tier%20Categories=*all">AWS Free Tier</a> - тут можно прочитать сколько вам в месяц выделяется того или иного ресурса бесплатно в рамках фри-тира.
:::</p><p>Ага - из-за негодяя <code>packer</code>-а помимо <code>AMI</code>-шек создаются еще и такие сущности.</p><p><img src="./static/aws-console.png" alt="snapshots"/></p><p>:::tip Мораль</p><ul><li>пермым делом во фри-тире сделайте не рутового пользователя, вторым настройте <a href="https://www.youtube.com/watch?v=XNeAH4dch0g">биллинг алерты</a> (я бы поставил трешхолд на 50% - в моем случае бюджет таял быстро). </li><li>Авторам видео / гайдлайнов, конечно, стоило бы указывать, что это не входит во фри-тир - или входит, но слабые лимиты.
:::</li></ul>]]></content>
        <author>
            <name>Andrew Horbach</name>
            <uri>https://github.com/karma-git</uri>
        </author>
    </entry>
</feed>