<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://your-docusaurus-test-site.com/Andrew-Horbach.github.io-Public/blog</id>
    <title>Andrew Horbach Blog</title>
    <updated>2022-01-28T00:00:00.000Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://your-docusaurus-test-site.com/Andrew-Horbach.github.io-Public/blog"/>
    <subtitle>Andrew Horbach Blog</subtitle>
    <icon>https://your-docusaurus-test-site.com/Andrew-Horbach.github.io-Public/img/favicon.ico</icon>
    <entry>
        <title type="html"><![CDATA[Selfmade Vagrant box]]></title>
        <id>selfmade-vagrant-box</id>
        <link href="https://your-docusaurus-test-site.com/Andrew-Horbach.github.io-Public/blog/selfmade-vagrant-box"/>
        <updated>2022-01-28T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[VagrantBox собирается настолько же просто как и DockerImage!]]></summary>
        <content type="html"><![CDATA[<p>На VagrantCloud не нашел нормальных box-ов с GUI.</p><h2>Процесс</h2><p>:::info
Буду делать аналогии с <em>docker</em>
:::</p><h3>config file</h3><p>Описываем конфигурацию нашего VagrantBox (<em>DockerImage</em>) в формате <code>.hcl</code> (<em>terraform</em>)</p><pre><code class="language-hcl">source &quot;vagrant&quot; &quot;ubuntu&quot; {
  add_force    = true
  communicator = &quot;ssh&quot;
  provider     = &quot;virtualbox&quot;
  source_path  = &quot;ubuntu/focal64&quot;
}

build {
  name    = &quot;learn-packer&quot;
  sources = [
    &quot;source.vagrant.ubuntu&quot;
  ]
}
</code></pre><p>:::tip
Полезные команды:</p><pre><code class="language-shell">packer validate packer.hcl  # валидирует файл
packer fmt .                # форматирует файлы, и кажется, выполняет валидацию
</code></pre><p>:::</p><h3>build</h3><p>С помощью <a href="https://www.packer.io/"><code>packer</code></a> (<em>docker engine</em>) собираем образ.</p><pre><code class="language-shell">packer build packer.hcl
</code></pre><p>Через некоторое время в директории <code>learn-packer</code> появится файл <code>.box</code> (<em>docker_image</em>)</p><h3>push</h3><p>Заливаем получившийся файл на <a href="https://app.vagrantup.com/boxes/search">VagrantCloud</a>. Понадобиться собрать хэш-сумму файла, например через <code>md5</code></p><h3>provisioner</h3><p>:::note
Любимый провиженер - ansible, но можно использовать <code>shell</code>
:::</p><div><div value="hcl" label="packer.hcl"><pre><code class="language-hcl">source &quot;vagrant&quot; &quot;ubuntu&quot; {
  add_force    = true
  communicator = &quot;ssh&quot;
  provider     = &quot;virtualbox&quot;
  source_path  = &quot;ubuntu/focal64&quot;
}

build {
  name    = &quot;learn-packer&quot;
  sources = [
    &quot;source.vagrant.ubuntu&quot;
  ]
  provisioner &quot;ansible&quot; {
    playbook_file = &quot;./ansible/packer-playbook.yml&quot;
  }
}
</code></pre></div><div value="yml" label="packer-playbook.yml"><pre><code class="language-yml">---

- name: install docker engine ubuntu
  hosts: all

  become: true
  become_method: sudo

  tasks:
    - name: 1. Update the apt package index and install packages to allow apt to use a repository over HTTPS
      apt:
        name: 
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
          - python3-pip
          - awscli
        state: latest
        update_cache: true

    - name: 2. Add Docker’s official GPG key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: 3. Add Docker Repository
      apt_repository:
        repo: deb https://download.docker.com/linux/ubuntu focal stable  # FIXME move to var
        state: present

    - name: 4. Install docker engine
      apt:
        name: docker-ce
        state: latest
        update_cache: true

    # Docker post-install steps for ubuntu

    - name: 1. Make sure that group &quot;docker&quot; exists
      group:
        name: docker
        state: present

    - name: 2. Add aws user to docker docker group
      user:
        name: ubuntu
        groups: docker
        append: true
</code></pre></div></div><h3>post-processors</h3><p>:::caution
Не протестировал
:::</p><p>Штуки которые выполняются после сборки, например публикация в <em>VagrantCloud</em> (<em>docker push</em>)</p><p><a href="https://github.com/karma-git/playground/tree/master/environment/vagrant/ubuntu-gui">GitHub repo</a></p>]]></content>
        <author>
            <name>Andrew Horbach</name>
            <uri>https://github.com/karma-git</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Vagrant - DevOps Environment]]></title>
        <id>vagrant-karma-linux</id>
        <link href="https://your-docusaurus-test-site.com/Andrew-Horbach.github.io-Public/blog/vagrant-karma-linux"/>
        <updated>2021-02-01T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Собрал Linux для людей]]></summary>
        <content type="html"><![CDATA[<h1>Inspiration</h1><p>Буквально недавно <a href="blog/selfmade-vagrant-box">писал</a> про сборку <code>Vagrant</code>-а, <strong>доделалъ</strong> :tada:, в двух версиях:</p><ul><li>в серверной работаем через ssh </li><li>и gui, установлены разные desktop приложения :computer:</li></ul><p><a href="https://asciinema.org/a/58jLHlUsCZA63uGjIClQcX5r0"><img src="https://asciinema.org/a/58jLHlUsCZA63uGjIClQcX5r0.svg" alt="asciicast"/></a></p><p>:::info &quot;Этапы&quot;</p><ul><li><a href="https://github.com/karma-git/playground/tree/master/environment/vagrant/build">Сборка Packer-ом</a></li><li><a href="https://github.com/karma-git/playground/tree/master/ansible">Ansible</a></li><li><a href="https://app.vagrantup.com/karma-kit">Vagrant Cloud</a></li><li><a href="https://github.com/karma-git/playground/tree/master/environment/vagrant/examples">Vagrantfile examples</a></li></ul><p>:::</p><p>Или схематично:</p><div chart="
  sequenceDiagram
    participant Packer
    participant Vagrant
    participant Ansible
    Packer-&gt;&gt;Vagrant: Launch tmp VM
    Note right of Vagrant: !NOTE: at low level Vagrant uses Virtualbox API
    Vagrant-&gt;&gt;Ansible: Configure tmp VM
    Ansible--&gt;&gt;Vagrant: Done!
    Vagrant--&gt;&gt;Packer: Done!
    %% loop Artifact
    %%     Ansible-&gt;&gt;Packer: Create Vagrant box from current VM state.
    %% end
    note over Packer: Creates Vagrant box from current VM state.
    note over Packer: Releases the Vagrant box on Vagrant Cloud.
"></div><h1>Установка на Windows</h1><p>Проверьте ресурсы вашей host OS:</p><p>CPU</p><pre><code class="language-powershell">WMIC CPU Get DeviceID,NumberOfCores,NumberOfLogicalProcessors
</code></pre><p>Версию OS и общий объем RAM:</p><pre><code class="language-powershell">systeminfo |findstr /c:&quot;OS Name&quot; /c:&quot;Total Physical Memory&quot;
</code></pre><p><img src="static/vagrant-windows.png" alt="img"/></p><p>:::tip &quot;Рекомедованные ресурсы&quot;</p><ul><li>2 vpcu</li><li>4Gi RAM
:::</li></ul><p>Вам потребуется:</p><ul><li><a href="https://www.virtualbox.org/wiki/Downloads">VirtualBox</a></li><li><a href="https://www.vagrantup.com/docs/installation">Vagrant</a></li></ul><h1>VirtualBox Guest Additions</h1><blockquote><p><a href="https://docs.oracle.com/cd/E36500_01/E36502/html/qs-guest-additions.html">6.4. Installing the VirtualBox Guest Additions</a></p></blockquote><p>:::info</p><p>Это, пожалуй, самое больное в использовании virtualbox - открыть гую на весь экран. Тут я не буду вам давать никаких обещаний, могу лишь накинуть идеи как вам с этим справиться:</p><p>:::</p><h2>vbguest vagrant plugin</h2><p>:::danger
У меня сработало лишь один раз :skull:
:::</p><pre><code class="language-shell">vagrant plugin uninstall vagrant-vbguest
vagrant destroy -f
vagrant up
vagrant plugin install vagrant-vbguest
vagrant vbguest --do install
</code></pre><h2>ansible galaxy</h2><p>Используйте мой <a href="https://github.com/karma-git/playground/tree/master/environment/vagrant/examples/karma-kit-devops-gui">пример</a> - Guest Additions установит ansible роль. </p><p>:::caution</p><p>Гарантию, что у вас все сработает дать невозможно, но скорее всего понадобятся минимальные телодвижения.</p><p>:::</p><h2>Секретный вариант</h2><p>Всегда можно погуглить / посмотреть ютуб на тему как сделать <code>Virtualbox</code> на весь экран :wink:</p><p>Удачи и да прибудет с вами сила!</p><p>:::tip</p><p>Если не смотрели, исправьтесь:</p><div class="video-wrapper"><iframe height="540" frameborder="0" width="50%" src="https://www.youtube.com/embed/n1F_MfLRlX0"></iframe></div><p>:::</p>]]></content>
        <author>
            <name>Andrew Horbach</name>
            <uri>https://github.com/karma-git</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[AWS Free Tier и Packer Tutorial]]></title>
        <id>aws-ebs-snapshot</id>
        <link href="https://your-docusaurus-test-site.com/Andrew-Horbach.github.io-Public/blog/aws-ebs-snapshot"/>
        <updated>2021-01-30T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Используете AWS Free Tier? Настроили Billing Alarms?]]></summary>
        <content type="html"><![CDATA[<h1>Предыстория</h1><p>Когда я только знакомился с AWS по youtube плейлисту, я смастерил <code>VPC</code> в двух <code>AZ</code> с несколькими подсетями. Один из типов подсетей был private - с <code>nat-gateway</code>, в курсах забыли сказать, что они не входят во фритир. За пару дней за 2 гейта накапало около <strong>$6</strong>. Было обидно, я поставил биллинг аларм.</p><p>:::info #!NOTE
Тот самый курс от <a href="https://www.youtube.com/watch?v=8jbx8O3wuLg&amp;list=PLg5SS_4L6LYsxrZ_4xE_U95AtGsIB96k9">Курс ADV-IT</a>
:::</p><h1>История</h1><p>Совсем недавно я учился (на котиках) созданию артефактов с помощью <a href="./blog/selfmade-vagrant-box">packer</a>. После тренировки в AWS я со спокойной душой в console нужного региона убил все <code>AMI</code> и пошел дальше.</p><p>Неделю спустя в почте заметил очередное письмо от AWS (мне иногда на личный gmail аккаунт приходят от них billing репорты, всегда пустые, и приглашения не <a href="https://reinvent.awsevents.com/">re:invent</a>).</p><p><img src="./static/aws-ebs-snapshot-warn.png" alt="alert"/></p><p>Увидел что я потратил 85% <em>&quot;фри-тирного&quot;</em> места под снэпшоты ebs дисков.</p><p>:::info
<a href="https://aws.amazon.com/free/?all-free-tier.sort-by=item.additionalFields.SortRank&amp;all-free-tier.sort-order=asc&amp;awsf.Free%20Tier%20Types=*all&amp;awsf.Free%20Tier%20Categories=*all">AWS Free Tier</a> - тут можно прочитать сколько вам в месяц выделяется того или иного ресурса бесплатно в рамках фри-тира.
:::</p><p>Ага - из-за негодяя <code>packer</code>-а помимо <code>AMI</code>-шек создаются еще и такие сущности.</p><p><img src="./static/aws-console.png" alt="snapshots"/></p><p>:::tip Мораль</p><ul><li>пермым делом во фри-тире сделайте не рутового пользователя, вторым настройте <a href="https://www.youtube.com/watch?v=XNeAH4dch0g">биллинг алерты</a> (я бы поставил трешхолд на 50% - в моем случае бюджет таял быстро). </li><li>Авторам видео / гайдлайнов, конечно, стоило бы указывать, что это не входит во фри-тир - или входит, но слабые лимиты.
:::</li></ul>]]></content>
        <author>
            <name>Andrew Horbach</name>
            <uri>https://github.com/karma-git</uri>
        </author>
    </entry>
</feed>